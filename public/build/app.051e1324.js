window.jQuery=window.$;var imports=["madisonApp.filters","madisonApp.services","madisonApp.resources","madisonApp.directives","madisonApp.controllers","ui","ui.router","ngAnimate","ngSanitize","angular-growl","ngResource","angular-tour","ipCookie"],app=angular.module("madisonApp",imports),xhReq=new XMLHttpRequest;xhReq.open("GET","/auth/token",!1),xhReq.send(null),app.constant("CSRF_TOKEN",xhReq.responseText),history.pushState||window.location.hash&&window.location.replace("/"!==window.location.pathname?"/#"+window.location.hash.substr(1):"/#"+window.location.pathname),app.config(["growlProvider","$httpProvider","$stateProvider","$urlRouterProvider",function(a,b,c,d){a.messagesKey("messages"),a.messageTextKey("text"),a.messageSeverityKey("severity"),a.onlyUniqueMessages(!0),a.globalTimeToLive(5e3),b.interceptors.push(a.serverMessagesInterceptor),d.otherwise("404"),c.state("index",{url:"/",controller:"HomePageController",templateUrl:"/templates/pages/home.html",data:{title:"Madison Home"}}).state("login",{url:"/user/login",controller:"LoginPageController",templateUrl:"/templates/pages/login.html",data:{title:"Login to Madison"}}).state("signup",{url:"/user/signup",controller:"SignupPageController",templateUrl:"/templates/pages/signup.html",data:{title:"Signup for Madison"}}).state("password-reset",{url:"/password/reset",controller:"PasswordResetController",templateUrl:"/templates/pages/password-reset.html",data:{title:"Password Reset"}}).state("faq",{url:"/faq",templateUrl:"/templates/pages/faq.html",data:{title:"Frequently Asked Questions"}}).state("about",{url:"/about",templateUrl:"/templates/pages/about.html",data:{title:"About Madison"}}).state("privacy-policy",{url:"/privacy-policy",templateUrl:"/templates/pages/privacy-policy.html",data:{title:"Privacy Policy"}}).state("copyright",{url:"/copyright",templateUrl:"/templates/pages/copyright.html",data:{title:"Copyright Policy"}}).state("terms-and-conditions",{url:"/terms-and-conditions",templateUrl:"/templates/pages/terms-and-conditions.html",data:{title:"Terms and Conditions"}}).state("user-notification-settings",{url:"/user/edit/:user/notifications",controller:"UserNotificationsController",templateUrl:"/templates/pages/user-notification-settings.html",data:{title:"Notification Settings"}}).state("404",{url:"/404",templateUrl:"/templates/pages/404.html",data:{title:"Here Be Dragons"}})}]),app.config(function(a){a.html5Mode(!0)}),window.console=window.console||{},window.console.log=window.console.log||function(){},angular.module("madisonApp.controllers",[]),angular.module("madisonApp.controllers").controller("AppController",["$scope","ipCookie","UserService",function(a,b,c){a.$on("userUpdated",function(){a.user=c.user}),c.getUser(),a.step_messages={step_0:"Welcome to Madison!  Help create better policy in your community.  Click Next to continue.",step_1:"Getting Started:  Choose a policy document.  You can browse, or filter by title, category, sponsor, or status. Go ahead, choose one!",step_2:"Next, dive in! Scroll or use the Table of Contents to get to the good stuff.",step_3:"Share ideas and questions with the document sponsor and other users in the Discussion tab.",step_4:"Suggest specific changes to the text.  Just highlight part of the document and add your thoughts!"},a.currentStep=b("myTour")||0,a.stepComplete=function(){b("myTour",a.currentStep,{path:"/",expires:3650})},a.tourComplete=function(){b("myTour",99,{path:"/",expires:3650})}}]),angular.module("madisonApp.controllers").controller("HomePageController",["$scope","$filter","Doc",function(a,b,c){a.docs=[],a.categories=[],a.sponsors=[],a.statuses=[],a.dates=[],a.dateSort="",a.select2="",a.docSort="created_at",a.reverse=!0,a.startStep=0,c.query(function(b){a.parseDocs(b)}).$promise["catch"](function(a){console.error("Unable to get documents: %o",a)}),a.select2Config={multiple:!0,allowClear:!0,placeholder:"Filter documents by category, sponsor, or status"},a.dateSortConfig={allowClear:!0,placeholder:"Sort By Date"},a.parseDocs=function(b){angular.forEach(b,function(b){a.docs.push(b),a.parseDocMeta(b.categories,"categories"),a.parseDocMeta(b.sponsor,"sponsors"),a.parseDocMeta(b.statuses,"statuses"),angular.forEach(b.dates,function(a){a.date=Date.parse(a.date)})})},a.parseDocMeta=function(c,d){0!==c.length&&angular.forEach(c,function(c){var e=b("getById")(a[d],c.id);if(null===e)switch(d){case"categories":a.categories.push(c);break;case"sponsors":a.sponsors.push(c);break;case"statuses":a.statuses.push(c);break;default:console.error("Unknown meta name: "+d)}})},a.docFilter=function(b){var c=!1;if(void 0!==a.select2&&""!==a.select2){var d=!0,e=a.select2.split("_"),f=e[0],g=parseInt(e[1],10);switch(f){case"category":angular.forEach(b.categories,function(a){+a.id===g&&d&&(c=!0,d=!1)});break;case"sponsor":angular.forEach(b.sponsor,function(a){+a.id===g&&d&&(c=!0,d=!1)});break;case"status":angular.forEach(b.statuses,function(a){+a.id===g&&d&&(c=!0,d=!1)})}}else c=!0;return c}}]),angular.module("madisonApp.directives",[]).directive("profileCompletionMessage",["$http",function(a){return{restrict:"A",templateUrl:"/templates/profile-completion-message.html",link:function(b){b.updateEmail=function(c,d){a.put("/api/user/"+b.user.id+"/edit/email",{email:c,password:d}).success(function(){b.user.email=c}).error(function(a){console.error("Error updating user email: %o",a)})}}}}]).directive("docComments",function(){return{restrict:"AECM",templateUrl:"/templates/doc-comments.html"}}).directive("ngBlur",function(){return function(a,b,c){b.bind("blur",function(){a.$apply(c.ngBlur)})}}).directive("docLink",function(a,b){function c(c,d,e){a.get("/api/docs/"+e.docId).success(function(a){var e='<a href="/docs/'+a.slug+'">'+a.title+"</a>",f=b(e)(c);d.replaceWith(f)}).error(function(a){console.error("Unable to retrieve document %o: %o",e.docId,a)})}return{restrict:"AECM",link:c}}).directive("docListItem",function(){return{restrict:"A",templateUrl:"/templates/doc-list-item.html"}}).directive("annotationItem",["growl",function(a){return{restrict:"A",transclude:!0,templateUrl:"/templates/annotation-item.html",compile:function(){return{post:function(b,c,d){var e=c.find(".comment-link").first(),f=window.location.origin+window.location.pathname+"#"+d.activityItemLink;$(e).attr("data-clipboard-text",f);var g=new ZeroClipboard(e);g.on("aftercopy",function(){b.$apply(function(){a.addSuccessMessage("Link copied to clipboard.")})})}}}}}]).directive("commentItem",["growl",function(a){return{restrict:"A",transclude:!0,templateUrl:"/templates/comment-item.html",compile:function(){return{post:function(b,c,d){var e=c.find(".comment-link").first(),f=window.location.origin+window.location.pathname+"#"+d.activityItemLink;$(e).attr("data-clipboard-text",f);var g=new ZeroClipboard(e);g.on("aftercopy",function(){b.$apply(function(){a.addSuccessMessage("Link copied to clipboard.")})})}}}}}]).directive("subcommentLink",["growl","$anchorScroll","$timeout",function(a,b,c){return{restrict:"A",template:'<span class="glyphicon glyphicon-link" title="Copy link to clipboard"></span>',compile:function(){return{post:function(d,e,f){var g=e,h=window.location.origin+window.location.pathname+"#subcomment_"+f.subCommentId;$(g).attr("data-clipboard-text",h);var i=new ZeroClipboard(g);i.on("aftercopy",function(){d.$apply(function(){a.addSuccessMessage("Link copied to clipboard.")})}),c(function(){b()},0)}}}}}]).directive("activitySubComment",["growl","$anchorScroll","$timeout",function(a,b,c){return{restrict:"A",transclude:!0,templateUrl:"/templates/activity-sub-comment.html",compile:function(){return{post:function(d,e,f){var g=e.find(".subcomment-link").first(),h=window.location.origin+window.location.pathname+"#annsubcomment_"+f.subCommentId;$(g).attr("data-clipboard-text",h);var i=new ZeroClipboard(g);i.on("aftercopy",function(){d.$apply(function(){a.addSuccessMessage("Link copied to clipboard.")})}),c(function(){b()},0)}}}}}]).directive("socialLogin",[function(){return{restrict:"A",scope:{message:"@message"},templateUrl:"/templates/social-login.html"}}]).directive("updateTitle",["$rootScope","$timeout",function(a,b){return{link:function(c,d){var e=function(a,c){var e="Madison";c.data&&c.data.title&&(e=c.data.title),b(function(){d.text(e)},0,!1)};a.$on("$stateChangeSuccess",e)}}}]).directive("accountDropdown",["UserService","AuthService","$location","growl",function(a,b,c,d){return{scope:!0,link:function(e){e.$watch(function(){return a.user},function(a){e.user=a}),e.logout=function(){var e=b.logout();e.then(function(){d.addSuccessMessage("You have been successfully logged out."),a.getUser(),c.path("/")})}},templateUrl:"/templates/partials/account-dropdown.html"}}]),angular.module("madisonApp.filters",[]).filter("parseDate",function(){return function(a){return Date.parse(a)}}).filter("toArray",function(){return function(a){return a instanceof Object?_.map(a,function(a,b){return a.$key=b,a}):a}}).filter("gravatar",function(){return function(a){var b="";return void 0!==a&&(b=CryptoJS.MD5(a.toLowerCase())),b}}).filter("getById",function(){return function(a,b){var c=0,d=a.length;for(c;d>c;c++)if(+a[c].id===+b)return a[c];return null}}),angular.module("madisonApp.resources",[]).factory("Doc",function(a){return a("/api/docs/:id")}),angular.module("madisonApp.services",[]).factory("UserService",["$rootScope","$http",function(a,b){var c={};return c.user={},c.getUser=function(){c.exists=b.get("/api/user/current").success(function(b){c.user=b.user,a.$broadcast("userUpdated")})},c}]).factory("AuthService",["$http","$sanitize",function(a,b){return{login:function(b){var c=a.post("/api/user/login",b);return c},logout:function(){var b=a.get("/api/user/logout");return b},signup:function(b){var c=a.post("/api/user/signup",b);return c}}}]).factory("createLoginPopup",["$document","$timeout",function(a,b){var c=a.find("body"),d=a.find("html"),e=function(){d.on("click.popup",function(){$(".popup").remove(),d.off("click.popup")})},f=function(a,b){var c=$(a);c.submit(function(a){a.preventDefault(),$.post(c.attr("action"),c.serialize(),function(a){if(a.errors&&Object.keys(a.errors).length){var d=$("<ul></ul>");$(a.errors).each(function(b,c){d.append("<li>"+a.errors[c][0]+"</li>")}),c.find(".errors").html(d)}else b(a)})})};return function(a){console.log(a);var d=$('<div class="popup unauthed-popup"><p>Please log in.</p><input type="button" id="login" value="Login" class="btn btn-primary"/><input type="button" id="signup" value="Sign up" class="btn btn-primary" /></div>');d.on("click.popup",function(a){a.stopPropagation()}),$("#login",d).click(function(a){a.stopPropagation(),a.preventDefault(),$.get("/api/user/login/",{},function(a){a=$(a),f(a.find("form"),function(){$("html").trigger("click.popup"),location.reload(!1)}),d.html(a)})}),$("#signup",d).click(function(a){a.stopPropagation(),a.preventDefault(),$.get("/api/user/signup/",{},function(a){a=$(a),f(a.find("form"),function(a){$("html").trigger("click.popup"),alert(a.message)}),d.html(a)})}),c.append(d);var g={top:a.clientY-d.height(),left:a.clientX};d.css(g).css("position","absolute"),d.css("z-index","999"),b(function(){e()},50)}}]).factory("annotationService",function(a,b){var c={},d=new Markdown.Converter;return c.annotations=[],c.setAnnotations=function(a){angular.forEach(a,function(a){a.html=b.trustAsHtml(d.makeHtml(a.text)),this.annotations.push(a)},this),this.broadcastUpdate()},c.addAnnotation=function(a){if(void 0===a.id)var c=window.setInterval(function(){this.addAnnotation(a),window.clearInterval(c)}.bind(this),500);else a.html=b.trustAsHtml(d.makeHtml(a.text)),this.annotations.push(a),this.broadcastUpdate()},c.broadcastUpdate=function(){a.$broadcast("annotationsUpdated")},c}).service("modalService",["$modal",function(a){var b={backdrop:!0,keyboard:!0,modalFade:!0,templateUrl:"/templates/modal.html"},c={closeButtonText:"Close",actionButtonText:!1,headerText:"Notice",bodyText:"Hmm... someone forgot the content here..."};this.showModal=function(a,b){return a||(a={}),a.backdrop=!0,this.show(a,b)},this.show=function(d,e){var f={},g={};return angular.extend(f,b,d),angular.extend(g,c,e),f.controller||(f.controller=function(a,b){a.modalOptions=g,a.modalOptions.ok=function(a){b.close(a)},a.modalOptions.close=function(){b.dismiss("cancel")}}),a.open(f).result}}]);