function googleTranslateElementInit(){new google.translate.TranslateElement({pageLanguage:"en"},"google_translate_element")}angular.module("madisonApp.controllers",[]),angular.module("madisonApp.controllers").controller("AppController",["$scope","ipCookie","UserService",function(a,b,c){a.$on("userUpdated",function(){a.user=c.user}),c.getUser(),a.step_messages={step_0:"Welcome to Madison!  Help create better policy in your community.  Click Next to continue.",step_1:"Getting Started:  Choose a policy document.  You can browse, or filter by title, category, sponsor, or status. Go ahead, choose one!",step_2:"Next, dive in! Scroll or use the Table of Contents to get to the good stuff.",step_3:"Share ideas and questions with the document sponsor and other users in the Discussion tab.",step_4:"Suggest specific changes to the text.  Just highlight part of the document and add your thoughts!"},a.currentStep=b("myTour")||0,a.stepComplete=function(){b("myTour",a.currentStep,{path:"/",expires:3650})},a.tourComplete=function(){b("myTour",99,{path:"/",expires:3650})}}]),angular.module("madisonApp.controllers").controller("PasswordResetController",["AuthService",function(){}]),angular.module("madisonApp.resources",[]).factory("Doc",function(a){return a("/api/docs/:id")}),angular.module("madisonApp.dashboardControllers",[]).controller("DashboardVerifyGroupController",["$scope","$http",function(a,b){a.requests=[],a.init=function(){a.getRequests()},a.getRequests=function(){b.get("/api/groups/verify").success(function(b){a.requests=b}).error(function(a){console.error(a)})},a.update=function(a,c){b.post("/api/groups/verify",{request:a,status:c}).success(function(){a.status=c}).error(function(a){console.error(a)})}}]).controller("DashboardVerifyUserController",["$scope","$http",function(a,b){a.requests=[],a.init=function(){a.getRequests()},a.getRequests=function(){b.get("/api/user/independent/verify").success(function(b){a.requests=b}).error(function(a){console.error(a)})},a.update=function(a,c){b.post("/api/user/independent/verify",{request:a,status:c}).success(function(){a.meta_value=c,location.reload()}).error(function(a){console.error(a)})}}]).controller("DashboardDocumentsController",["$scope","$http","$filter",function(a,b,c){a.docs=[],a.categories=[],a.sponsors=[],a.statuses=[],a.dates=[],a.dateSort="",a.select2="",a.docSort="created_at",a.reverse=!0,a.select2Config={multiple:!0,allowClear:!0,placeholder:"Filter documents by category, sponsor, or status"},a.dateSortConfig={allowClear:!0,placeholder:"Sort By Date"},b.get("/api/docs").success(function(b){a.parseDocs(b)}).error(function(a){console.error("Unable to get documents: %o",a)}),a.parseDocs=function(b){angular.forEach(b,function(b){a.docs.push(b),a.parseDocMeta(b.categories,"categories"),a.parseDocMeta(b.sponsor,"sponsors"),a.parseDocMeta(b.statuses,"statuses"),angular.forEach(b.dates,function(a){a.date=Date.parse(a.date)})})},a.parseDocMeta=function(b,d){void 0!==b&&0!==b.length&&angular.forEach(b,function(b){var e=c("getById")(a[d],b.id);if(null===e)switch(d){case"categories":a.categories.push(b);break;case"sponsors":a.sponsors.push(b);break;case"statuses":a.statuses.push(b);break;default:console.error("Unknown meta name: "+d)}})},a.docFilter=function(b){var c=!1;if(void 0!==a.select2&&""!==a.select2){var d=!0,e=a.select2.split("_"),f=e[0],g=parseInt(e[1],10);switch(f){case"category":angular.forEach(b.categories,function(a){+a.id===g&&d&&(c=!0,d=!1)});break;case"sponsor":angular.forEach(b.sponsor,function(a){+a.id===g&&d&&(c=!0,d=!1)});break;case"status":angular.forEach(b.statuses,function(a){+a.id===g&&d&&(c=!0,d=!1)})}}else c=!0;return c}}]).controller("DashboardVerifyController",["$scope","$http",function(a,b){a.requests=[],a.init=function(){a.getRequests()},a.getRequests=function(){b.get("/api/user/verify").success(function(b){a.requests=b}).error(function(a){console.error(a)})},a.update=function(a,c){b.post("/api/user/verify",{request:a,status:c}).success(function(){a.meta_value=c}).error(function(a){console.error(a)})}}]).controller("DashboardSettingsController",["$scope","$http",function(a,b){a.admins=[],a.getAdmins=function(){b.get("/api/user/admin").success(function(b){a.admins=b}).error(function(a){console.error(a)})},a.saveAdmin=function(a){a.saved=!1,b.post("/api/user/admin",{admin:a}).success(function(){a.saved=!0}).error(function(a){console.error(a)})},a.init=function(){a.getAdmins()}}]).controller("DashboardEditorController",["$scope","$http","$timeout","$location","$filter","growl",function(a,b,c,d,e,f){a.doc={},a.sponsor={},a.status={},a.newdate={label:"",date:new Date},a.verifiedUsers=[],a.categories=[],a.introtext="",a.suggestedCategories=[],a.suggestedStatuses=[],a.dates=[],a.init=function(){function b(a){return a.toLowerCase().replace(/[^a-zA-Z0-9\- ]/g,"").replace(/ +/g,"-")}var e=d.absUrl(),f=e.match(/.*\/(\d+)$/)[1],g=a.getDoc(f);a.getAllCategories(),a.getVerifiedUsers(),a.setSelectOptions();var h=!0,i=!0,j=!0,k=!0,l=!0,m=!0;g.then(function(){new Markdown.Editor(Markdown.getSanitizingConverter()).run(),$("#wmd-preview").css("overflow","scroll"),$("#wmd-preview").css("height",$("#wmd-input").height()+22),$("#wmd-input").scroll(function(){$("#wmd-preview").scrollTop($("#wmd-input").scrollTop())});var d=null;a.updateIntroText=function(b){d&&c.cancel(d),d=c(function(){a.saveIntroText(b)},3e3)},a.getDocSponsor().then(function(){a.$watch("sponsor",function(){i?c(function(){i=!1}):a.saveSponsor()})}),a.getDocStatus().then(function(){a.$watch("status",function(){j?c(function(){j=!1}):a.saveStatus()})}),a.getDocCategories().then(function(){a.$watch("categories",function(){h?c(function(){h=!1}):a.saveCategories()})}),a.getIntroText(),a.getDocDates(),a.$watch("doc.title",function(){k?c(function(){k=!1}):a.saveTitle()}),a.$watch("doc.slug",function(){if(l)c(function(){l=!1});else{var d=a.doc.slug,e=b(d);d==e?a.saveSlug():(console.log("Invalid slug, reverting"),a.doc.slug=e)}});var e=null;a.$watch("doc.content.content",function(){m?c(function(){m=!1}):(e&&c.cancel(e),e=c(function(){a.saveContent()},5e3))})})},a.getShortUrl=function(){var c={username:"madison-robot",password:"MeV3MJJE",api:"http://opngv.us/yourls-api.php"},e=a.doc.slug,g=d.protocol()+"://"+d.host()+"/docs/"+e;b({url:c.api,method:"JSONP",params:{callback:"JSON_CALLBACK",action:"shorturl",format:"jsonp",url:g,username:c.username,password:c.password}}).success(function(b){a.short_url=b.shorturl}).error(function(a){console.error(a),f.addErrorMessage("There was an error generating your short url.")})},a.setSelectOptions=function(){a.categoryOptions={placeholder:"Add document categories",multiple:!0,simple_tags:!0,tokenSeparators:[","],tags:function(){return a.suggestedCategories},results:function(){return a.categories},initSelection:function(b,c){var d=[];angular.forEach(a.categories,function(a,b){d.push(angular.copy({id:b,text:a}))}),c(d)}},a.statusOptions={placeholder:"Select Document Status",ajax:{url:"/api/docs/statuses",dataType:"json",data:function(){},results:function(a){var b=[];return angular.forEach(a,function(a){b.push({id:a.id,text:a.label})}),{results:b}}},data:function(){return a.suggestedStatuses},results:function(){return a.status},createSearchChoice:function(a){return{id:a,text:a}},initSelection:function(b,c){c(a.status)},allowClear:!0},a.sponsorOptions={placeholder:"Select Document Sponsor",allowClear:!0,ajax:{url:"/api/user/sponsors/all",dataType:"json",data:function(){},results:function(a){var b=[];return a.success?(angular.forEach(a.sponsors,function(a){var c="";switch(a.sponsorType){case"group":c="[Group] "+a.name;break;case"user":c=a.fname+" "+a.lname+" - "+a.email}b.push({id:a.id,type:a.sponsorType,text:c})}),{results:b}):void alert(a.message)}},initSelection:function(b,c){c(a.sponsor)}}},a.statusChange=function(b){a.status=b},a.sponsorChange=function(b){a.sponsor=b},a.categoriesChange=function(b){a.categories=b},a.getDoc=function(c){return b.get("/api/docs/"+c).success(function(b){a.doc=b,angular.forEach(b.categories,function(b){a.categories.push(angular.copy(b.name))})})},a.saveTitle=function(){return b.post("/api/docs/"+a.doc.id+"/title",{title:a.doc.title}).success(function(a){console.log("Title saved successfully: %o",a)}).error(function(a){console.error("Error saving title for document:",a)})},a.saveSlug=function(){return b.post("/api/docs/"+a.doc.id+"/slug",{slug:a.doc.slug}).success(function(a){console.log("Slug sent: %o",a)}).error(function(a){console.error("Error saving slug for document:",a)})},a.saveContent=function(){return b.post("/api/docs/"+a.doc.id+"/content",{content:a.doc.content.content}).success(function(a){console.log("Content saved successfully: %o",a)}).error(function(a){console.error("Error saving content for document:",a)})},a.createDate=function(c){""!==a.newdate.label&&(a.newdate.date=e("date")(c,"short"),b.post("/api/docs/"+a.doc.id+"/dates",{date:a.newdate}).success(function(b){b.date=Date.parse(b.date),b.$changed=!1,a.dates.push(b),a.newdate={label:"",date:new Date}}).error(function(a){console.error("Unable to save date: %o",a)}))},a.deleteDate=function(c){b["delete"]("/api/docs/"+a.doc.id+"/dates/"+c.id).success(function(){var b=a.dates.indexOf(c);a.dates.splice(b,1)}).error(function(){console.error("Unable to delete date: %o",c)})},a.saveDate=function(a){var c=angular.copy(a);return c.date=e("date")(c.date,"short"),b.put("/api/dates/"+a.id,{date:c}).success(function(b){a.$changed=!1,console.log("Date saved successfully: %o",b)}).error(function(b){console.error("Unable to save date: %o (%o)",a,b)})},a.getDocDates=function(){return b.get("/api/docs/"+a.doc.id+"/dates").success(function(b){angular.forEach(b,function(b,c){b.date=Date.parse(b.date),b.$changed=!1,a.dates.push(angular.copy(b)),a.$watch("dates["+c+"]",function(a,b){angular.equals(a,b)||void 0===a||(a.$changed=!0)},!0)})}).error(function(a){console.error("Error getting dates: %o",a)})},a.getVerifiedUsers=function(){return b.get("/api/user/verify").success(function(b){angular.forEach(b,function(b){a.verifiedUsers.push(angular.copy(b.user))})}).error(function(a){console.error("Unable to get verified users: %o",a)})},a.getDocCategories=function(){return b.get("/api/docs/"+a.doc.id+"/categories").success(function(b){angular.forEach(b,function(b){a.categories.push(b.name)})}).error(function(b){console.error("Unable to get categories for document %o: %o",a.doc,b)})},a.getIntroText=function(){return b.get("/api/docs/"+a.doc.id+"/introtext").success(function(b){a.introtext=b.meta_value}).error(function(b){console.error("Unable to get Intro Text for document %o: %o",a.doc,b)})},a.getDocSponsor=function(){return b.get("/api/docs/"+a.doc.id+"/sponsor").success(function(b){if(void 0===b.sponsorType)return void(a.sponsor=null);var c="";switch(b.sponsorType.toLowerCase()){case"group":c="[Group] "+b.name;break;case"user":c=b.fname+" "+b.lname+" - "+b.email}a.sponsor={id:b.id,type:b.sponsorType.toLowerCase(),text:c}}).error(function(a){console.error("Error getting document sponsor: %o",a)})},a.getDocStatus=function(){return b.get("/api/docs/"+a.doc.id+"/status").success(function(b){a.status=void 0===b.id?null:{id:b.id,text:b.label}}).error(function(a){console.error("Error getting document status: %o",a)})},a.getAllStatuses=function(){b.get("/api/docs/statuses").success(function(b){angular.forEach(b,function(b){a.suggestedStatuses.push(b.label)})}).error(function(a){console.error("Unable to get document statuses: %o",a)})},a.getAllCategories=function(){return b.get("/api/docs/categories").success(function(b){angular.forEach(b,function(b){a.suggestedCategories.push(b.name)})}).error(function(a){console.error("Unable to get document categories: %o",a)})},a.saveStatus=function(){return b.post("/api/docs/"+a.doc.id+"/status",{status:a.status}).success(function(a){console.log("Status saved successfully: %o",a)}).error(function(a){console.error("Error saving status: %o",a)})},a.saveSponsor=function(){return b.post("/api/docs/"+a.doc.id+"/sponsor",{sponsor:a.sponsor}).success(function(a){console.log("Sponsor saved successfully: %o",a)}).error(function(a){console.error("Error saving sponsor: %o",a)})},a.saveCategories=function(){return b.post("/api/docs/"+a.doc.id+"/categories",{categories:a.categories}).success(function(a){console.log("Categories saved successfully: %o",a)}).error(function(b){console.error("Error saving categories for document %o: %o \n %o",a.doc,a.categories,b)})},a.saveIntroText=function(c){return b.post("/api/docs/"+a.doc.id+"/introtext",{"intro-text":c}).success(function(a){console.log("Intro Text saved successfully: %o",a)}).error(function(){console.error("Error saving intro text for document %o: %o",a.doc,a.introtext)})}}]),angular.module("madisonApp.services",[]).factory("UserService",["$rootScope","$http",function(a,b){var c={};return c.user={},c.getUser=function(){c.exists=b.get("/api/user/current").success(function(b){c.user=b.user,a.$broadcast("userUpdated")})},c}]).factory("AuthService",["$http","$sanitize",function(a,b){return{login:function(b){var c=a.post("/api/user/login",b);return c},logout:function(){var b=a.get("/api/user/logout");return b},signup:function(b){var c=a.post("/api/user/signup",b);return c}}}]).factory("createLoginPopup",["$document","$timeout",function(a,b){var c=a.find("body"),d=a.find("html"),e=function(){d.on("click.popup",function(){$(".popup").remove(),d.off("click.popup")})},f=function(a,b){var c=$(a);c.submit(function(a){a.preventDefault(),$.post(c.attr("action"),c.serialize(),function(a){if(a.errors&&Object.keys(a.errors).length){var d=$("<ul></ul>");$(a.errors).each(function(b,c){d.append("<li>"+a.errors[c][0]+"</li>")}),c.find(".errors").html(d)}else b(a)})})};return function(a){console.log(a);var d=$('<div class="popup unauthed-popup"><p>Please log in.</p><input type="button" id="login" value="Login" class="btn btn-primary"/><input type="button" id="signup" value="Sign up" class="btn btn-primary" /></div>');d.on("click.popup",function(a){a.stopPropagation()}),$("#login",d).click(function(a){a.stopPropagation(),a.preventDefault(),$.get("/api/user/login/",{},function(a){a=$(a),f(a.find("form"),function(){$("html").trigger("click.popup"),location.reload(!1)}),d.html(a)})}),$("#signup",d).click(function(a){a.stopPropagation(),a.preventDefault(),$.get("/api/user/signup/",{},function(a){a=$(a),f(a.find("form"),function(a){$("html").trigger("click.popup"),alert(a.message)}),d.html(a)})}),c.append(d);var g={top:a.clientY-d.height(),left:a.clientX};d.css(g).css("position","absolute"),d.css("z-index","999"),b(function(){e()},50)}}]).factory("annotationService",function(a,b){var c={},d=new Markdown.Converter;return c.annotations=[],c.setAnnotations=function(a){angular.forEach(a,function(a){a.html=b.trustAsHtml(d.makeHtml(a.text)),this.annotations.push(a)},this),this.broadcastUpdate()},c.addAnnotation=function(a){if(void 0===a.id)var c=window.setInterval(function(){this.addAnnotation(a),window.clearInterval(c)}.bind(this),500);else a.html=b.trustAsHtml(d.makeHtml(a.text)),this.annotations.push(a),this.broadcastUpdate()},c.broadcastUpdate=function(){a.$broadcast("annotationsUpdated")},c}).service("modalService",["$modal",function(a){var b={backdrop:!0,keyboard:!0,modalFade:!0,templateUrl:"/templates/modal.html"},c={closeButtonText:"Close",actionButtonText:!1,headerText:"Notice",bodyText:"Hmm... someone forgot the content here..."};this.showModal=function(a,b){return a||(a={}),a.backdrop=!0,this.show(a,b)},this.show=function(d,e){var f={},g={};return angular.extend(f,b,d),angular.extend(g,c,e),f.controller||(f.controller=function(a,b){a.modalOptions=g,a.modalOptions.ok=function(a){b.close(a)},a.modalOptions.close=function(){b.dismiss("cancel")}}),a.open(f).result}}]),angular.module("madisonApp.directives",[]).directive("profileCompletionMessage",["$http",function(a){return{restrict:"A",templateUrl:"/templates/profile-completion-message.html",link:function(b){b.updateEmail=function(c,d){a.put("/api/user/"+b.user.id+"/edit/email",{email:c,password:d}).success(function(){b.user.email=c}).error(function(a){console.error("Error updating user email: %o",a)})}}}}]).directive("docComments",function(){return{restrict:"AECM",templateUrl:"/templates/doc-comments.html"}}).directive("ngBlur",function(){return function(a,b,c){b.bind("blur",function(){a.$apply(c.ngBlur)})}}).directive("docLink",function(a,b){function c(c,d,e){a.get("/api/docs/"+e.docId).success(function(a){var e='<a href="/docs/'+a.slug+'">'+a.title+"</a>",f=b(e)(c);d.replaceWith(f)}).error(function(a){console.error("Unable to retrieve document %o: %o",e.docId,a)})}return{restrict:"AECM",link:c}}).directive("docListItem",function(){return{restrict:"A",templateUrl:"/templates/doc-list-item.html"}}).directive("annotationItem",["growl",function(a){return{restrict:"A",transclude:!0,templateUrl:"/templates/annotation-item.html",compile:function(){return{post:function(b,c,d){var e=c.find(".comment-link").first(),f=window.location.origin+window.location.pathname+"#"+d.activityItemLink;$(e).attr("data-clipboard-text",f);var g=new ZeroClipboard(e);g.on("aftercopy",function(){b.$apply(function(){a.addSuccessMessage("Link copied to clipboard.")})})}}}}}]).directive("commentItem",["growl",function(a){return{restrict:"A",transclude:!0,templateUrl:"/templates/comment-item.html",compile:function(){return{post:function(b,c,d){var e=c.find(".comment-link").first(),f=window.location.origin+window.location.pathname+"#"+d.activityItemLink;$(e).attr("data-clipboard-text",f);var g=new ZeroClipboard(e);g.on("aftercopy",function(){b.$apply(function(){a.addSuccessMessage("Link copied to clipboard.")})})}}}}}]).directive("subcommentLink",["growl","$anchorScroll","$timeout",function(a,b,c){return{restrict:"A",template:'<span class="glyphicon glyphicon-link" title="Copy link to clipboard"></span>',compile:function(){return{post:function(d,e,f){var g=e,h=window.location.origin+window.location.pathname+"#subcomment_"+f.subCommentId;$(g).attr("data-clipboard-text",h);var i=new ZeroClipboard(g);i.on("aftercopy",function(){d.$apply(function(){a.addSuccessMessage("Link copied to clipboard.")})}),c(function(){b()},0)}}}}}]).directive("activitySubComment",["growl","$anchorScroll","$timeout",function(a,b,c){return{restrict:"A",transclude:!0,templateUrl:"/templates/activity-sub-comment.html",compile:function(){return{post:function(d,e,f){var g=e.find(".subcomment-link").first(),h=window.location.origin+window.location.pathname+"#annsubcomment_"+f.subCommentId;$(g).attr("data-clipboard-text",h);var i=new ZeroClipboard(g);i.on("aftercopy",function(){d.$apply(function(){a.addSuccessMessage("Link copied to clipboard.")})}),c(function(){b()},0)}}}}}]).directive("socialLogin",[function(){return{restrict:"A",scope:{message:"@message"},templateUrl:"/templates/social-login.html"}}]).directive("updateTitle",["$rootScope","$timeout",function(a,b){return{link:function(c,d){var e=function(a,c){var e="Madison";c.data&&c.data.title&&(e=c.data.title),b(function(){d.text(e)},0,!1)};a.$on("$stateChangeSuccess",e)}}}]).directive("accountDropdown",["UserService","AuthService","$location","growl",function(a,b,c,d){return{scope:!0,link:function(e){e.$watch(function(){return a.user},function(a){e.user=a}),e.logout=function(){var e=b.logout();e.then(function(){d.addSuccessMessage("You have been successfully logged out."),a.getUser(),c.path("/")})}},templateUrl:"/templates/partials/account-dropdown.html"}}]),angular.module("madisonApp.filters",[]).filter("parseDate",function(){return function(a){return Date.parse(a)}}).filter("toArray",function(){return function(a){return a instanceof Object?_.map(a,function(a,b){return a.$key=b,a}):a}}).filter("gravatar",function(){return function(a){var b="";return void 0!==a&&(b=CryptoJS.MD5(a.toLowerCase())),b}}).filter("getById",function(){return function(a,b){var c=0,d=a.length;for(c;d>c;c++)if(+a[c].id===+b)return a[c];return null}}),window.getAnnotationService=function(){var a=angular.element($("html")),b=a.injector(),c=b.get("annotationService");return c},window.jQuery=window.$;var imports=["madisonApp.filters","madisonApp.services","madisonApp.resources","madisonApp.directives","madisonApp.controllers","madisonApp.dashboardControllers","ui.router"],app=angular.module("madisonApp",imports),xhReq=new XMLHttpRequest;xhReq.open("GET","/auth/token",!1),xhReq.send(null),app.constant("CSRF_TOKEN",xhReq.responseText),history.pushState||window.location.hash&&window.location.replace("/"!==window.location.pathname?"/#"+window.location.hash.substr(1):"/#"+window.location.pathname),app.config(["growlProvider","$httpProvider","$stateProvider","$urlRouterProvider",function(a,b,c){a.messagesKey("messages"),a.messageTextKey("text"),a.messageSeverityKey("severity"),b.responseInterceptors.push(a.serverMessagesInterceptor),a.onlyUniqueMessages(!0),a.globalTimeToLive(5e3),c.state("index",{url:"/",controller:"HomePageController",templateUrl:"/templates/pages/home.html",data:{title:"Madison Home"}}).state("login",{url:"/user/login",controller:"LoginPageController",templateUrl:"/templates/pages/login.html",data:{title:"Login to Madison"}}).state("signup",{url:"/user/signup",controller:"SignupPageController",templateUrl:"/templates/pages/signup.html",data:{title:"Signup for Madison"}}).state("password-reset",{url:"/password/reset",controller:"PasswordResetController",templateUrl:"/templates/pages/password-reset.html",data:{title:"Password Reset"}}).state("faq",{url:"/faq",templateUrl:"/templates/pages/faq.html",data:{title:"Frequently Asked Questions"}}).state("about",{url:"/about",templateUrl:"/templates/pages/about.html",data:{title:"About Madison"}}).state("privacy-policy",{url:"/privacy-policy",templateUrl:"/templates/pages/privacy-policy.html",data:{title:"Privacy Policy"}}).state("copyright",{url:"/copyright",templateUrl:"/templates/pages/copyright.html",data:{title:"Copyright Policy"}}).state("terms-and-conditions",{url:"/terms-and-conditions",templateUrl:"/templates/pages/terms-and-conditions.html",data:{title:"Terms and Conditions"}}).state("user-notification-settings",{url:"/user/edit/:user/notifications",controller:"UserNotificationsController",templateUrl:"/templates/pages/user-notification-settings.html",data:{title:"Notification Settings"}}).state("404",{url:"/404",templateUrl:"/templates/pages/404.html",data:{title:"Here Be Dragons"}})}]),app.config(function(a){a.html5Mode(!0)}),window.console=window.console||{},window.console.log=window.console.log||function(){};