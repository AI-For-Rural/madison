$(document).ready(function(){function n(){$("html").on("click.popup",function(){$(".popup").remove();$("html").off("click.popup")})}function r(e,t){var e=$(e);e.submit(function(n){n.preventDefault();$.post(e.attr("action"),e.serialize(),function(n){if(n.errors&&Object.keys(n.errors).length){var r=$("<ul></ul>");for(key in n.errors)r.append("<li>"+n.errors[key][0]+"</li>");console.log(e.find(".errors").length);e.find(".errors").html(r)}else t(n)})})}var e,t;if(user.id==""){var i=Annotator.prototype.checkForEndSelection;Annotator.prototype.checkForEndSelection=function(e){var i,s,o,u,a;this.mouseIsDown=!1;if(this.ignoreMouseup||$(".popup").length)return;this.selectedRanges=this.getSelectedRanges();a=this.selectedRanges;for(o=0,u=a.length;o<u;o++){s=a[o];i=s.commonAncestor;$(i).hasClass("annotator-hl")&&(i=$(i).parents("[class!=annotator-hl]")[0]);if(this.isAnnotator(i))return}if(e&&this.selectedRanges.length){e!=null&&e.preventDefault();t=$('<div class="popup unauthed-popup"><p>Login to comment.</p><input type="button" id="login" value="Login"/><input type="button" id="signup" value="Sign up"/></div>');t.on("click.popup",function(e){e.stopPropagation()});$("#login",t).click(function(e){e.stopPropagation();e.preventDefault();$.get("/api/user/login/",{},function(e){e=$(e);r(e.find("form"),function(e){$("html").trigger("click.popup");location.reload(!1)});t.html(e)})});$("#signup",t).click(function(e){e.stopPropagation();e.preventDefault();$.get("/api/user/signup/",{},function(e){e=$(e);r(e.find("form"),function(e){$("html").trigger("click.popup");alert(e.message)});t.html(e)})});$("body").append(t);var f={top:e.clientY-t.height(),left:e.clientY};t.css(f).css("position","absolute");this.ignoreMouseup=!1;setTimeout(n,50)}}}e=$("#content").annotator({});e.annotator("addPlugin","Unsupported");e.annotator("addPlugin","Tags");e.annotator("addPlugin","Markdown");e.annotator("addPlugin","Store",{annotationData:{uri:window.location.pathname,comments:[]},prefix:"/api/docs/"+doc.id+"/annotations",urls:{create:"",read:"/:id",update:"/:id",destroy:"/:id",search:"/search"}});e.annotator("addPlugin","Permissions",{user:user,permissions:{read:[],update:[user.id],"delete":[user.id],admin:[user.id]},showViewPermissionsCheckbox:!1,showEditPermissionsCheckbox:!1,userId:function(e){return e&&e.id?e.id:e},userString:function(e){return e&&e.name?e.name:e}});e.annotator("addPlugin","Madison",{userId:user.id})});